CONFIG set sysvshm=new
RESTART

ARG PG_VERSION=17
ARG PG_USER=admin
ARG PG_PASSWORD=password
ARG PG_DB=database

PKG postgresql${PG_VERSION}-server
PKG postgresql${PG_VERSION}-contrib
PKG sudo

SYSRC postgresql_enable=YES

CMD if [ ! -e /var/db/postgres/data${PG_VERSION} ];then service postgresql initdb; service postgresql start; fi

CMD echo 'host    ${PG_DB}             ${PG_USER}             192.168.1.0/24                     password' >> /var/db/postgres/data${PG_VERSION}/pg_hba.conf

CMD sed -i.bak "s/#listen_addresses = 'localhost'/listen_addresses = '*'/" /var/db/postgres/data${PG_VERSION}/postgresql.conf

SERVICE postgresql restart

# create user
# CMD su - postgres psql -c "CREATE ROLE ${PG_USER} WITH SUPERUSER LOGIN ENCRYPTED PASSWORD '${PG_PASSWORD}'"
# CMD su - postgres psql -c "CREATE USER ${PG_USER} WITH PASSWORD '${PG_PASSWORD}'"
# CMD su - postgres psql -c "ALTER USER ${PG_USER} LOGIN CREATEDB SUPERUSER"
# CMD su - postgres psql -c "CREATE DATABASE ${PG_USER}"


# create database
# CMD su - postgres psql -c "CREATE DATABASE ${PG_DB} OWNER ${PG_USER}"
CMD sudo -u postgres psql -c "CREATE DATABASE ${PG_DB}"
CMD sudo -u postgres psql -c "CREATE USER ${PG_USER} WITH ENCRYPTED PASSWORD '${PG_PASSWORD}'"
CMD sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE ${PG_DB} TO ${PG_USER}"
CMD sudo -u postgres psql -c "ALTER DATABASE ${PG_DB} OWNER TO ${PG_USER}"

