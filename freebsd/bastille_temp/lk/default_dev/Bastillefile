ARG hostname=dev
ARG user=lk

SYSRC sshd_enable=YES
SYSRC sendmail_enable=NONE

# set repository to latest
CMD mkdir -p /usr/local/etc/pkg/repos
CMD echo 'FreeBSD: { url: 'pkg+http://pkg.FreeBSD.org/\$\{ABI\}/latest', enabled: yes }' > /usr/local/etc/pkg/repos/FreeBSD.conf

SERVICE sshd start

# install packages
PKG git
PKG rsync
PKG doas
PKG helix
PKG fzf fd-find
# PKG neovim
PKG fish
PKG starship
PKG eza
PKG bat
PKG lazygit
PKG xstow

# set hostname
CMD hostname ${hostname}
CMD hostname

# create user
CMD echo "${user}" | pw user add -n ${user} -G wheel -s /usr/local/bin/fish -m -h 0
CMD users 

# configure 'doas'
CMD echo "permit nopass :wheel">>/usr/local/etc/doas.conf
CMD echo doas

# copy config files
MOUNT /home/lk/configs/conf_files /configs
# TODO: fix stow path
CMD xstow -t /home/${user}/ /config/conf_files/fish 

# copy ssh key for git
CMD mkdir /home/${user}/.ssh
CP /usr/home/lk/.ssh/id_ed25519 /home/${user}/.ssh/
CP /usr/home/lk/.ssh/id_ed25519.pub /home/${user}/.ssh/

# create working directory
CMD mkdir /usr/home/${user}/dev

# change owner root -> user
CMD chown -R ${user}:wheel /home/${user}
